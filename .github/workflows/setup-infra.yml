name: Setup Infrastructure

on:
  workflow_dispatch:

jobs:
  setup-supabase:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Supabase CLI
        run: |
          curl -sL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar xz
          sudo mv supabase /usr/local/bin/
          supabase --version

      - name: Create Supabase project
        id: supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -e
          ORG_ID=$(supabase orgs list --output json | jq -r '.[0].id')
          echo "Org ID: $ORG_ID"

          # Check if project already exists
          PROJECT_REF=$(supabase projects list --output json | jq -r '.[] | select(.name == "prompt-marketplace") | .id')

          if [ -z "$PROJECT_REF" ] || [ "$PROJECT_REF" = "null" ]; then
            echo "Creating new project..."
            supabase projects create prompt-marketplace \
              --db-password "PromptMkt2026Secure" \
              --region ap-northeast-1 \
              --org-id "$ORG_ID"
            echo "Waiting 120s for project to initialize..."
            sleep 120
            PROJECT_REF=$(supabase projects list --output json | jq -r '.[] | select(.name == "prompt-marketplace") | .id')
          else
            echo "Project already exists: $PROJECT_REF"
          fi

          if [ -z "$PROJECT_REF" ] || [ "$PROJECT_REF" = "null" ]; then
            echo "ERROR: Could not find project ref"
            exit 1
          fi

          # Pooler URL (port 6543) for runtime (Vercel/Next.js serverless)
          DATABASE_URL="postgresql://postgres.${PROJECT_REF}:PromptMkt2026Secure@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres?pgbouncer=true"
          # Direct URL (port 5432) for migrations/schema push
          DIRECT_URL="postgresql://postgres.${PROJECT_REF}:PromptMkt2026Secure@aws-0-ap-northeast-1.pooler.supabase.com:5432/postgres"
          echo "DATABASE_URL=${DATABASE_URL}" >> "$GITHUB_OUTPUT"
          echo "DIRECT_URL=${DIRECT_URL}" >> "$GITHUB_OUTPUT"
          echo "PROJECT_REF=${PROJECT_REF}" >> "$GITHUB_OUTPUT"

      - name: Wait for DB ready
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          PROJECT_REF="${{ steps.supabase.outputs.PROJECT_REF }}"
          echo "Checking project $PROJECT_REF status..."
          for i in $(seq 1 12); do
            STATUS=$(curl -s "https://api.supabase.com/v1/projects/${PROJECT_REF}" \
              -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}" | jq -r '.status')
            echo "Attempt $i: status=$STATUS"
            if [ "$STATUS" = "ACTIVE_HEALTHY" ]; then
              echo "Project is ready!"
              break
            fi
            echo "Waiting 30s..."
            sleep 30
          done
          # Final check
          STATUS=$(curl -s "https://api.supabase.com/v1/projects/${PROJECT_REF}" \
            -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}" | jq -r '.status')
          echo "Final status: $STATUS"
          if [ "$STATUS" != "ACTIVE_HEALTHY" ]; then
            echo "WARNING: Project not fully ready (status: $STATUS), proceeding anyway..."
          fi

      - name: Save secrets
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "${{ steps.supabase.outputs.DATABASE_URL }}" | gh secret set DATABASE_URL --repo ${{ github.repository }}
          echo "${{ steps.supabase.outputs.DIRECT_URL }}" | gh secret set DIRECT_URL --repo ${{ github.repository }}
          echo "${{ steps.supabase.outputs.PROJECT_REF }}" | gh secret set SUPABASE_PROJECT_REF --repo ${{ github.repository }}

      - name: Push Prisma schema
        id: prisma
        env:
          DATABASE_URL: ${{ steps.supabase.outputs.DIRECT_URL }}
          DIRECT_URL: ${{ steps.supabase.outputs.DIRECT_URL }}
        shell: bash
        run: |
          set +e
          LOG=/tmp/prisma-debug.log
          exec > >(tee -a "$LOG") 2>&1

          echo "=== ENV CHECK ==="
          echo "DATABASE_URL set: $([ -n "$DATABASE_URL" ] && echo 'yes' || echo 'NO')"
          echo "DIRECT_URL set: $([ -n "$DIRECT_URL" ] && echo 'yes' || echo 'NO')"

          echo "=== Step 1: npm ci ==="
          npm ci
          if [ $? -ne 0 ]; then echo "npm ci FAILED"; fi

          echo "=== Step 2: prisma generate ==="
          npx prisma generate
          if [ $? -ne 0 ]; then echo "prisma generate FAILED"; fi

          PROJECT_REF="${{ steps.supabase.outputs.PROJECT_REF }}"

          # Try multiple connection methods with retries
          URLS=(
            "postgresql://postgres.${PROJECT_REF}:PromptMkt2026Secure@aws-0-ap-northeast-1.pooler.supabase.com:5432/postgres"
            "postgresql://postgres:PromptMkt2026Secure@db.${PROJECT_REF}.supabase.co:5432/postgres"
            "postgresql://postgres.${PROJECT_REF}:PromptMkt2026Secure@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres"
          )
          NAMES=("session-pooler" "direct-host" "transaction-pooler")

          SUCCESS=0
          for idx in 0 1 2; do
            URL="${URLS[$idx]}"
            NAME="${NAMES[$idx]}"
            echo "=== Trying $NAME ==="
            export DATABASE_URL="$URL"
            export DIRECT_URL="$URL"
            for attempt in 1 2 3; do
              echo "--- $NAME attempt $attempt ---"
              npx prisma db push --accept-data-loss
              if [ $? -eq 0 ]; then
                echo "SUCCESS with $NAME!"
                SUCCESS=1
                break 2
              fi
              sleep 15
            done
          done

          EXIT1=$SUCCESS
          if [ "$SUCCESS" -eq 0 ]; then
            EXIT1=1
            echo "All connection methods failed"
          else
            EXIT1=0
          fi

          echo "=== Writing summary ==="
          echo '## Prisma Push Log' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat "$LOG" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          exit $EXIT1

      - name: Post debug log as issue
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          if [ -f /tmp/prisma-debug.log ]; then
            LOG_CONTENT=$(head -200 /tmp/prisma-debug.log)
            gh issue create --repo ${{ github.repository }} \
              --title "setup-infra debug $(date -u +%H:%M)" \
              --body "$LOG_CONTENT" || echo "Could not create issue"
          else
            echo "No debug log found"
          fi

      - name: Set Vercel environment variables
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          DATABASE_URL: ${{ steps.supabase.outputs.DATABASE_URL }}
        run: |
          PROJECTS=$(curl -s "https://api.vercel.com/v9/projects" \
            -H "Authorization: Bearer $VERCEL_TOKEN")
          PROJECT_ID=$(echo "$PROJECTS" | jq -r '.projects[] | select(.name | contains("prompt-marketplace")) | .id' | head -1)

          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
            echo "Could not find Vercel project. Skipping."
            echo "## Vercel" >> $GITHUB_STEP_SUMMARY
            echo "Project not found. Available:" >> $GITHUB_STEP_SUMMARY
            echo "$PROJECTS" | jq '.projects[].name' >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            exit 0
          fi

          NEXTAUTH_SECRET=$(openssl rand -base64 32)
          DIRECT_URL="${{ steps.supabase.outputs.DIRECT_URL }}"

          for KEY_VAL in "DATABASE_URL:${DATABASE_URL}" "DIRECT_URL:${DIRECT_URL}" "NEXTAUTH_SECRET:${NEXTAUTH_SECRET}"; do
            KEY=$(echo "$KEY_VAL" | cut -d: -f1)
            VAL=$(echo "$KEY_VAL" | cut -d: -f2-)
            for TARGET in production preview development; do
              curl -s -X POST "https://api.vercel.com/v10/projects/${PROJECT_ID}/env" \
                -H "Authorization: Bearer $VERCEL_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"key\":\"${KEY}\",\"value\":\"${VAL}\",\"target\":[\"${TARGET}\"],\"type\":\"encrypted\"}" || true
            done
          done

          curl -s -X POST "https://api.vercel.com/v10/projects/${PROJECT_ID}/env" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"key":"NEXTAUTH_URL","value":"https://prompt-marketplace-tau.vercel.app","target":["production"],"type":"plain"}' || true

          echo "Vercel env vars set!"

      - name: Summary
        if: always()
        run: |
          echo "## Infrastructure Setup" >> $GITHUB_STEP_SUMMARY
          echo "- Project ref: ${{ steps.supabase.outputs.PROJECT_REF }}" >> $GITHUB_STEP_SUMMARY
          echo "- Region: ap-northeast-1" >> $GITHUB_STEP_SUMMARY
