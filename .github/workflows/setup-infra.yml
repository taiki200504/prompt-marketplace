name: Setup Infrastructure

on:
  workflow_dispatch:

jobs:
  setup-supabase:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Supabase CLI
        run: |
          curl -sL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar xz
          sudo mv supabase /usr/local/bin/
          supabase --version

      - name: Get or create Supabase project
        id: supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -e
          ORG_ID=$(supabase orgs list --output json | jq -r '.[0].id')

          PROJECT_REF=$(supabase projects list --output json | jq -r '.[] | select(.name == "prompt-marketplace") | .id')

          if [ -z "$PROJECT_REF" ] || [ "$PROJECT_REF" = "null" ]; then
            echo "Creating new project..."
            supabase projects create prompt-marketplace \
              --db-password "PromptMkt2026Secure" \
              --region ap-northeast-1 \
              --org-id "$ORG_ID"
            sleep 180
            PROJECT_REF=$(supabase projects list --output json | jq -r '.[] | select(.name == "prompt-marketplace") | .id')
          else
            echo "Project exists: $PROJECT_REF"
          fi

          echo "PROJECT_REF=${PROJECT_REF}" >> "$GITHUB_OUTPUT"

          # Get connection details from API
          PROJECT_JSON=$(curl -s "https://api.supabase.com/v1/projects/${PROJECT_REF}" \
            -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}")
          POOLER_JSON=$(curl -s "https://api.supabase.com/v1/projects/${PROJECT_REF}/config/database/pooler" \
            -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}")

          # Get actual pooler host from API
          POOLER_HOST=$(echo "$POOLER_JSON" | jq -r '.[0].db_host')
          POOLER_PORT=$(echo "$POOLER_JSON" | jq -r '.[0].db_port')
          DB_HOST=$(echo "$PROJECT_JSON" | jq -r '.database.host')
          echo "Pooler: $POOLER_HOST:$POOLER_PORT | DB: $DB_HOST"

          # Construct URLs
          DATABASE_URL="postgresql://postgres.${PROJECT_REF}:PromptMkt2026Secure@${POOLER_HOST}:${POOLER_PORT}/postgres"
          DIRECT_URL="postgresql://postgres.${PROJECT_REF}:PromptMkt2026Secure@${DB_HOST}:5432/postgres"
          echo "DATABASE_URL=${DATABASE_URL}" >> "$GITHUB_OUTPUT"
          echo "DIRECT_URL=${DIRECT_URL}" >> "$GITHUB_OUTPUT"
          echo "POOLER_HOST=${POOLER_HOST}" >> "$GITHUB_OUTPUT"

      - name: Save secrets
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "${{ steps.supabase.outputs.DATABASE_URL }}" | gh secret set DATABASE_URL --repo ${{ github.repository }}
          echo "${{ steps.supabase.outputs.DIRECT_URL }}" | gh secret set DIRECT_URL --repo ${{ github.repository }}
          echo "${{ steps.supabase.outputs.PROJECT_REF }}" | gh secret set SUPABASE_PROJECT_REF --repo ${{ github.repository }}

      - name: Push Prisma schema
        env:
          DATABASE_URL: ${{ steps.supabase.outputs.DIRECT_URL }}
          DIRECT_URL: ${{ steps.supabase.outputs.DIRECT_URL }}
        run: |
          npm ci
          npx prisma generate
          npx prisma db push --accept-data-loss
          echo "Schema pushed successfully!"

      - name: Set Vercel environment variables
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          DATABASE_URL: ${{ steps.supabase.outputs.DATABASE_URL }}
        run: |
          PROJECTS=$(curl -s "https://api.vercel.com/v9/projects" \
            -H "Authorization: Bearer $VERCEL_TOKEN")
          PROJECT_ID=$(echo "$PROJECTS" | jq -r '.projects[] | select(.name | contains("prompt-marketplace")) | .id' | head -1)

          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
            echo "Vercel project not found. Skipping."
            exit 0
          fi

          NEXTAUTH_SECRET=$(openssl rand -base64 32)
          DIRECT_URL="${{ steps.supabase.outputs.DIRECT_URL }}"

          for KEY_VAL in "DATABASE_URL:${DATABASE_URL}" "DIRECT_URL:${DIRECT_URL}" "NEXTAUTH_SECRET:${NEXTAUTH_SECRET}"; do
            KEY=$(echo "$KEY_VAL" | cut -d: -f1)
            VAL=$(echo "$KEY_VAL" | cut -d: -f2-)
            for TARGET in production preview development; do
              curl -s -X POST "https://api.vercel.com/v10/projects/${PROJECT_ID}/env" \
                -H "Authorization: Bearer $VERCEL_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"key\":\"${KEY}\",\"value\":\"${VAL}\",\"target\":[\"${TARGET}\"],\"type\":\"encrypted\"}" || true
            done
          done

          curl -s -X POST "https://api.vercel.com/v10/projects/${PROJECT_ID}/env" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"key":"NEXTAUTH_URL","value":"https://prompt-marketplace-tau.vercel.app","target":["production"],"type":"plain"}' || true

          echo "Vercel env vars set!"

      - name: Summary
        if: always()
        run: |
          echo "## Infrastructure Setup" >> $GITHUB_STEP_SUMMARY
          echo "- Project ref: ${{ steps.supabase.outputs.PROJECT_REF }}" >> $GITHUB_STEP_SUMMARY
          echo "- Pooler: ${{ steps.supabase.outputs.POOLER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- Region: ap-northeast-1" >> $GITHUB_STEP_SUMMARY
