name: Setup Infrastructure

on:
  workflow_dispatch:

jobs:
  setup-supabase:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Supabase CLI
        run: |
          curl -sL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar xz
          sudo mv supabase /usr/local/bin/
          supabase --version

      - name: Get or create Supabase project
        id: supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -e
          ORG_ID=$(supabase orgs list --output json | jq -r '.[0].id')

          PROJECT_REF=$(supabase projects list --output json | jq -r '.[] | select(.name == "prompt-marketplace") | .id')

          if [ -z "$PROJECT_REF" ] || [ "$PROJECT_REF" = "null" ]; then
            echo "Creating new project..."
            supabase projects create prompt-marketplace \
              --db-password "PromptMkt2026Secure" \
              --region ap-northeast-1 \
              --org-id "$ORG_ID"
            sleep 180
            PROJECT_REF=$(supabase projects list --output json | jq -r '.[] | select(.name == "prompt-marketplace") | .id')
          else
            echo "Project exists: $PROJECT_REF"
          fi

          echo "PROJECT_REF=${PROJECT_REF}" >> "$GITHUB_OUTPUT"

          # Get full connection details from API and post to issue for debugging
          echo "=== Project details ==="
          PROJECT_JSON=$(curl -s "https://api.supabase.com/v1/projects/${PROJECT_REF}" \
            -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}")
          echo "$PROJECT_JSON" | jq '.'

          echo "=== Pooler settings ==="
          POOLER_JSON=$(curl -s "https://api.supabase.com/v1/projects/${PROJECT_REF}/config/database/pooler" \
            -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}")
          echo "$POOLER_JSON" | jq '.'

          echo "=== API keys ==="
          KEYS_JSON=$(curl -s "https://api.supabase.com/v1/projects/${PROJECT_REF}/api-keys" \
            -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}")
          echo "Key count: $(echo "$KEYS_JSON" | jq 'length')"

          # Post diagnostic to issue
          DIAG="Project: $PROJECT_REF\n\nProject JSON:\n\`\`\`\n$(echo "$PROJECT_JSON" | jq '.')\n\`\`\`\n\nPooler JSON:\n\`\`\`\n$(echo "$POOLER_JSON" | jq '.')\n\`\`\`"
          gh issue comment 19 --repo ${{ github.repository }} --body "$(echo -e "$DIAG")" || true

          # Construct URLs
          DATABASE_URL="postgresql://postgres.${PROJECT_REF}:PromptMkt2026Secure@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres?pgbouncer=true"
          DIRECT_URL="postgresql://postgres.${PROJECT_REF}:PromptMkt2026Secure@aws-0-ap-northeast-1.pooler.supabase.com:5432/postgres"
          echo "DATABASE_URL=${DATABASE_URL}" >> "$GITHUB_OUTPUT"
          echo "DIRECT_URL=${DIRECT_URL}" >> "$GITHUB_OUTPUT"

      - name: Reset DB password
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          PROJECT_REF="${{ steps.supabase.outputs.PROJECT_REF }}"

          # Reset password
          RESULT=$(curl -s -X PUT "https://api.supabase.com/v1/projects/${PROJECT_REF}/database/password" \
            -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"password": "PromptMkt2026Secure"}')
          echo "Password reset result: $RESULT"

          # Post result
          gh issue comment 19 --repo ${{ github.repository }} --body "Password reset: $RESULT" || true

          echo "Waiting 30s for password propagation..."
          sleep 30

      - name: Save secrets
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "${{ steps.supabase.outputs.DATABASE_URL }}" | gh secret set DATABASE_URL --repo ${{ github.repository }}
          echo "${{ steps.supabase.outputs.DIRECT_URL }}" | gh secret set DIRECT_URL --repo ${{ github.repository }}
          echo "${{ steps.supabase.outputs.PROJECT_REF }}" | gh secret set SUPABASE_PROJECT_REF --repo ${{ github.repository }}

      - name: Push Prisma schema
        id: prisma
        env:
          DATABASE_URL: ${{ steps.supabase.outputs.DIRECT_URL }}
          DIRECT_URL: ${{ steps.supabase.outputs.DIRECT_URL }}
        shell: bash
        run: |
          set +e
          LOG=/tmp/prisma-debug.log
          exec > >(tee -a "$LOG") 2>&1

          npm ci
          npx prisma generate

          PROJECT_REF="${{ steps.supabase.outputs.PROJECT_REF }}"

          URLS=(
            "postgresql://postgres.${PROJECT_REF}:PromptMkt2026Secure@aws-0-ap-northeast-1.pooler.supabase.com:5432/postgres"
            "postgresql://postgres:PromptMkt2026Secure@db.${PROJECT_REF}.supabase.co:5432/postgres"
            "postgresql://postgres.${PROJECT_REF}:PromptMkt2026Secure@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres"
          )
          NAMES=("session-pooler" "direct-host" "transaction-pooler")

          SUCCESS=0
          for idx in 0 1 2; do
            echo "=== Trying ${NAMES[$idx]} ==="
            export DATABASE_URL="${URLS[$idx]}"
            export DIRECT_URL="${URLS[$idx]}"
            for attempt in 1 2 3; do
              echo "--- attempt $attempt ---"
              npx prisma db push --accept-data-loss && { SUCCESS=1; break 2; }
              sleep 15
            done
          done

          echo '## Prisma Push Log' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat "$LOG" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          [ "$SUCCESS" -eq 1 ] && exit 0 || exit 1

      - name: Post debug log as issue
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          [ -f /tmp/prisma-debug.log ] && \
            gh issue create --repo ${{ github.repository }} \
              --title "setup-infra debug $(date -u +%H:%M)" \
              --body "$(head -200 /tmp/prisma-debug.log)" || true

      - name: Set Vercel environment variables
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          DATABASE_URL: ${{ steps.supabase.outputs.DATABASE_URL }}
        run: |
          PROJECTS=$(curl -s "https://api.vercel.com/v9/projects" \
            -H "Authorization: Bearer $VERCEL_TOKEN")
          PROJECT_ID=$(echo "$PROJECTS" | jq -r '.projects[] | select(.name | contains("prompt-marketplace")) | .id' | head -1)

          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
            echo "Vercel project not found. Skipping."
            exit 0
          fi

          NEXTAUTH_SECRET=$(openssl rand -base64 32)
          DIRECT_URL="${{ steps.supabase.outputs.DIRECT_URL }}"

          for KEY_VAL in "DATABASE_URL:${DATABASE_URL}" "DIRECT_URL:${DIRECT_URL}" "NEXTAUTH_SECRET:${NEXTAUTH_SECRET}"; do
            KEY=$(echo "$KEY_VAL" | cut -d: -f1)
            VAL=$(echo "$KEY_VAL" | cut -d: -f2-)
            for TARGET in production preview development; do
              curl -s -X POST "https://api.vercel.com/v10/projects/${PROJECT_ID}/env" \
                -H "Authorization: Bearer $VERCEL_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"key\":\"${KEY}\",\"value\":\"${VAL}\",\"target\":[\"${TARGET}\"],\"type\":\"encrypted\"}" || true
            done
          done

          curl -s -X POST "https://api.vercel.com/v10/projects/${PROJECT_ID}/env" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"key":"NEXTAUTH_URL","value":"https://prompt-marketplace-tau.vercel.app","target":["production"],"type":"plain"}' || true

          echo "Vercel env vars set!"

      - name: Summary
        if: always()
        run: |
          echo "## Infrastructure Setup" >> $GITHUB_STEP_SUMMARY
          echo "- Project ref: ${{ steps.supabase.outputs.PROJECT_REF }}" >> $GITHUB_STEP_SUMMARY
          echo "- Region: ap-northeast-1" >> $GITHUB_STEP_SUMMARY
