name: Setup Infrastructure

on:
  workflow_dispatch:

jobs:
  setup-supabase:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Supabase CLI
        run: |
          curl -sL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar xz
          sudo mv supabase /usr/local/bin/
          supabase --version

      - name: Create Supabase project
        id: supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -e
          echo "=== Listing organizations ==="
          supabase orgs list

          ORG_ID=$(supabase orgs list --output json | jq -r '.[0].id')
          echo "Org ID: $ORG_ID"

          echo "=== Listing existing projects ==="
          supabase projects list

          echo "=== Creating new project ==="
          supabase projects create prompt-marketplace \
            --db-password "PromptMkt2026Secure" \
            --region ap-northeast-1 \
            --org-id "$ORG_ID" || echo "Project creation returned non-zero (may already exist)"

          echo "=== Waiting for project to initialize ==="
          sleep 90

          echo "=== Getting project ref ==="
          supabase projects list
          PROJECT_REF=$(supabase projects list --output json | jq -r '.[] | select(.name == "prompt-marketplace") | .id')
          echo "Project ref: $PROJECT_REF"

          if [ -z "$PROJECT_REF" ] || [ "$PROJECT_REF" = "null" ]; then
            echo "ERROR: Could not find project ref"
            supabase projects list --output json
            exit 1
          fi

          # Pooler URL (port 6543) for runtime (Vercel/Next.js)
          DATABASE_URL="postgresql://postgres.${PROJECT_REF}:PromptMkt2026Secure@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres?pgbouncer=true"
          # Direct URL (port 5432) for migrations/schema push
          DIRECT_URL="postgresql://postgres:PromptMkt2026Secure@db.${PROJECT_REF}.supabase.co:5432/postgres"
          echo "DATABASE_URL=${DATABASE_URL}" >> "$GITHUB_OUTPUT"
          echo "DIRECT_URL=${DIRECT_URL}" >> "$GITHUB_OUTPUT"
          echo "PROJECT_REF=${PROJECT_REF}" >> "$GITHUB_OUTPUT"
          echo "Database URLs constructed successfully"

      - name: Save secrets
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "${{ steps.supabase.outputs.DATABASE_URL }}" | gh secret set DATABASE_URL --repo ${{ github.repository }}
          echo "${{ steps.supabase.outputs.DIRECT_URL }}" | gh secret set DIRECT_URL --repo ${{ github.repository }}
          echo "${{ steps.supabase.outputs.PROJECT_REF }}" | gh secret set SUPABASE_PROJECT_REF --repo ${{ github.repository }}
          echo "Secrets saved!"

      - name: Push Prisma schema
        env:
          DATABASE_URL: ${{ steps.supabase.outputs.DIRECT_URL }}
          DIRECT_URL: ${{ steps.supabase.outputs.DIRECT_URL }}
        run: |
          npm ci
          npx prisma generate
          echo "=== Pushing schema (with retries) ==="
          for attempt in 1 2 3 4; do
            echo "Attempt $attempt..."
            if npx prisma db push --accept-data-loss 2>&1; then
              echo "Schema pushed successfully!"
              exit 0
            fi
            echo "Failed, waiting 30s before retry..."
            sleep 30
          done
          echo "All attempts failed"
          exit 1

      - name: Set Vercel environment variables
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          DATABASE_URL: ${{ steps.supabase.outputs.DATABASE_URL }}
        run: |
          PROJECTS=$(curl -s "https://api.vercel.com/v9/projects" \
            -H "Authorization: Bearer $VERCEL_TOKEN")
          PROJECT_ID=$(echo "$PROJECTS" | jq -r '.projects[] | select(.name | contains("prompt-marketplace")) | .id' | head -1)

          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
            echo "Could not find Vercel project. Available:"
            echo "$PROJECTS" | jq '.projects[].name' 2>/dev/null || echo "$PROJECTS"
            echo "Skipping Vercel env setup"
            exit 0
          fi

          echo "Vercel Project ID: $PROJECT_ID"

          NEXTAUTH_SECRET=$(openssl rand -base64 32)

          DIRECT_URL="${{ steps.supabase.outputs.DIRECT_URL }}"
          for KEY_VAL in "DATABASE_URL:${DATABASE_URL}" "DIRECT_URL:${DIRECT_URL}" "NEXTAUTH_SECRET:${NEXTAUTH_SECRET}"; do
            KEY=$(echo "$KEY_VAL" | cut -d: -f1)
            VAL=$(echo "$KEY_VAL" | cut -d: -f2-)
            for TARGET in production preview development; do
              curl -s -X POST "https://api.vercel.com/v10/projects/${PROJECT_ID}/env" \
                -H "Authorization: Bearer $VERCEL_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"key\":\"${KEY}\",\"value\":\"${VAL}\",\"target\":[\"${TARGET}\"],\"type\":\"encrypted\"}" || true
            done
          done

          curl -s -X POST "https://api.vercel.com/v10/projects/${PROJECT_ID}/env" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"key":"NEXTAUTH_URL","value":"https://prompt-marketplace-tau.vercel.app","target":["production"],"type":"plain"}' || true

          echo "Vercel env vars set!"

      - name: Summary
        if: always()
        run: |
          echo "## Infrastructure Setup" >> $GITHUB_STEP_SUMMARY
          echo "- Project ref: ${{ steps.supabase.outputs.PROJECT_REF }}" >> $GITHUB_STEP_SUMMARY
          echo "- Region: ap-northeast-1" >> $GITHUB_STEP_SUMMARY
